#!/usr/bin/env ruby

root = File.expand_path('../..', __FILE__)
require File.join(root, %w[lib mmm-agent])

# Initialize the logger
require 'syslog/logger'
log = Syslog::Logger.new 'mmm-agent'
log.info "Starting version #{MmmAgent.version}"

# Load the settings
begin
  Settings.load!('/etc/mmm-agent.yaml')
rescue Errno::ENOENT
  puts "Please copy config/mmm-agent.yaml in /etc and configure it before running this agent."
  log.error "Missing configuration file, stopping here..."
  exit
end

# Get hardware informations on the host
host = MmmAgent::Host.new
log.info "hostname is #{host.hostname}"
log.info "Found #{host.cpu.human_readable}"
log.info "Found #{host.gpu.size} GPUs:"
host.gpu.each do |gpu|
  log.info "#{gpu.model} (#{gpu.uuid})"
end

# Check we can get GPU clock speeds and store the stats correctly
host.gpu[0].update_stats
sleep 1
host.gpu[0].update_stats
log.info "GPU #0 clock average is #{host.gpu[0].gpu_clock.avg.to_i} Mhz (#{host.gpu[0].gpu_clock.min}/#{host.gpu[0].gpu_clock.max})"

